## üë®üèª‚Äçüíª –î–ó ‚Ññ 11. –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
1. [–ó–∞–¥–∞–Ω–∏–µ 1.](#–∑–∞–¥–∞–Ω–∏–µ_1)

### **–ó–∞–¥–∞–Ω–∏–µ 1.** <a name="–∑–∞–¥–∞–Ω–∏–µ_1"></a>

<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞–Ω–∏–µ üîΩ</summary>
–ó–∞–¥–∞–Ω–∏–µ:

–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ 10 ¬´–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫¬ª –∏ 
–≥–ª–∞–≤—ã 12 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –ü–æ—Å—Ç–≥—Ä–µ—Å https://postgrespro.ru/docs/postgresql/12/textsearch

**–ó–∞–¥–∞–Ω–∏–µ**. –ü—Ä–∏–¥—É–º–∞—Ç—å –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, 
–∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π (–º–æ–∂–Ω–æ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –∏–ª–∏ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π) —Ç–æ–º—É –ø—Ä–∏–º–µ—Ä—É —Å –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–º 
–∫–∞—Ç–∞–ª–æ–≥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–∏–≤–µ–¥–µ–Ω –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ 
—Ç–µ–∫—Å—Ç—ã, –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–µ –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏: https://edu.postgrespro.ru/sqlprimer/sqlprimer-2019-msu-10.tgz
</details>

–û—Ç–≤–µ—Ç:

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è —è —Ä–µ—à–∏–ª –≤–∑—è—Ç—å –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π
–∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏, –∞ –∏–º–µ–Ω–Ω–æ: –¥–∞—Ç–∞—Å–µ—Ç –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö 
–ø–∏—Å–µ–º: https://www.kaggle.com/datasets/wcukierski/enron-email-dataset/data

–ü–æ—Å–∫–æ–ª—å–∫—É –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –Ω–∞–±–æ—Ä–µ –∏—Ö –±–æ–ª—å—à–µ 500 —Ç—ã—Å., –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
—è —Å–¥–µ–ª–∞–ª —Å–ª—É—á–∞–π–Ω—É—é –≤—ã–±–æ—Ä–∫—É –∏–∑ 10 —Ç—ã—Å. –ø–∏—Å–µ–º, –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∞–ª –∏—Ö
–Ω–∞ —è–∑—ã–∫–µ python, —á—Ç–æ–±—ã –æ–Ω–∏ –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏–ª–∏ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç –∑–∞–¥–∞–Ω–∏—è.
–í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, —è —É–±—Ä–∞–ª –ª–∏—à–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ 
–¥–∞—Ç—É –ø–∏—Å—å–º–∞, —Ç–µ–º—É –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.

–ú–æ—è –≤—ã–±–æ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–¥–µ—Å—å: [emails-sample.csv](./emails-sample.csv) (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: `^`).

–ò—Ç–∞–∫, –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è, –≤ –Ω–∞—á–∞–ª–µ —è —Å–æ–∑–¥–∞–º
—Ç–∞–±–ª–∏—Ü—É –Ω—É–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:
```SQL
CREATE TABLE emails
( email_id integer PRIMARY KEY,
  email_content text
);

CREATE TABLE
```

–î–∞–ª—å—à–µ —è —Å–∫–æ–ø–∏—Ä—É—é –≤ –Ω–µ–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ csv-—Ñ–∞–π–ª–∞, –≥–¥–µ —É–∂–µ –µ—Å—Ç—å 
—Å—Ç–æ–ª–±–µ—Ü —Å –∏–Ω–¥–µ–∫—Å–æ–º:
```SQL
COPY emails FROM '/home/postgres/emails-sample.csv' ( FORMAT CSV, DELIMITER('^') );
```

–¢–µ–ø–µ—Ä—å —è —Å–æ–∑–¥–∞–º —Å—Ç–æ–ª–±–µ—Ü —Å —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö `tsvector`, —á—Ç–æ–±—ã
–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç—ã —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º:
```SQL
ALTER TABLE emails ADD COLUMN ts_description tsvector;

ALTER TABLE
```

–ò –ø–µ—Ä–µ–¥–∞–º –≤ –Ω–µ–≥–æ –ø–∏—Å—å–º–∞:
```SQL
UPDATE emails
SET ts_description = to_tsvector( 'english',
                                  email_content );
                                  
–ó–ê–ú–ï–ß–ê–ù–ò–ï:  —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
–ü–û–î–†–û–ë–ù–û–°–¢–ò:  –°–ª–æ–≤–∞ –¥–ª–∏–Ω–Ω–µ–µ 2047 —Å–∏–º–≤–æ–ª–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
```

–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –≤ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è —è —É–∑–Ω–∞–ª, —á—Ç–æ —É 
—Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö `tsvector` –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Å–∏–º–≤–æ–ª–∞–º: 2047.
–í –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞.

–ú–æ–∂–µ–º –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø–∏—Å–µ–º:
```SQL
SELECT * 
FROM emails
WHERE length(email_content) < 200
LIMIT 5 ;

-[ RECORD 1 ]--+---------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 838
email_content  | Date: Tue, 27 Nov 2001 11:21:51 -0800 (PST) Subject: Content: http://www.familyfeud.tv/
ts_description | '-0800':9 '11':6 '2001':5 '21':7 '27':3 '51':8 'content':12 'date':1 'nov':4 'pst':10 'subject':11 'tue':2 'www.familyfeud.tv':13
-[ RECORD 2 ]--+---------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 5488
email_content  | Date: Thu, 15 Jun 2000 00:56:00 -0700 (PDT) Subject: Re: TigersContent: daddy is in.
ts_description | '-0700':9 '00':6,8 '15':3 '2000':5 '56':7 'daddi':14 'date':1 'jun':4 'pdt':10 're':12 'subject':11 'thu':2 'tigerscont':13
-[ RECORD 3 ]--+---------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 1499
email_content  | Date: Mon, 20 Nov 2000 00:10:00 -0800 (PST) Subject: testContent: test
ts_description | '-0800':9 '00':6,8 '10':7 '20':3 '2000':5 'date':1 'mon':2 'nov':4 'pst':10 'subject':11 'test':13 'testcont':12
-[ RECORD 4 ]--+---------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 7505
email_content  | Date: Wed, 22 Nov 2000 04:39:00 -0800 (PST) Subject: Content: Here is the latest Brownsville Presentation.Ben
ts_description | '-0800':9 '00':8 '04':6 '2000':5 '22':3 '39':7 'brownsvill':17 'content':12 'date':1 'latest':16 'nov':4 'presentation.ben':18 'pst':10 'subject':11 'wed':2
-[ RECORD 5 ]--+---------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 1867
email_content  | Date: Tue, 11 Dec 2001 11:40:10 -0800 (PST) Subject: Termination List 12-10Content: Attached is the termination list for Dec. 12.
ts_description | '-0800':9 '-10':15 '10':8 '11':3,6 '12':14,24 '2001':5 '40':7 'attach':17 'content':16 'date':1 'dec':4,23 'list':13,21 'pst':10 'subject':11 'termin':12,20 'tue':2
```

–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞–∫–æ–µ-–Ω–∏–±—É–¥—å –ø–∏—Å—å–º–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É:
```SQL
SELECT * FROM emails
WHERE ts_description @@ to_tsquery(
 'we & were & there & for & new & yearafter & a & california & visit' 
 );
 
-[ RECORD 1 ]--+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
email_id       | 137
email_content  | Date: Tue, 16 Jan 2001 15:13:00 -0800 (PST) Subject: key westContent: thanks for your call about travel to key west. we were there for new yearafter a california visit. i will be back on jan 24 for a week. it would begreat to see you there. if you need a place to stay my friend del brixeyhas a room that might be available. let me know your dates etc...best to ted and you from us both, hal and doneley_________________________________________________________________Get your FREE download of MSN Explorer at http://explorer.msn.com
ts_description | '-0800':9 '00':8 '13':7 '15':6 '16':3 '2001':5 '24':38 'avail':65 'back':35 'begreat':44 'best':72 'brixeyha':59 'california':30 'call':17 'date':1,70 'del':58 'doneley':82 'download':86 'etc':71 'explor':89 'explorer.msn.com':91 'free':85 'friend':57 'get':83 'hal':80 'jan':4,37 'key':12,21 'know':68 'let':66 'might':63 'msn':88 'need':51 'new':27 'place':53 'pst':10 'room':61 'see':46 'stay':55 'subject':11 'ted':74 'thank':14 'travel':19 'tue':2 'us':78 'visit':31 'week':41 'west':22 'westcont':13 'would':43 'yearaft':28
```

–°—Ä–µ–¥–∏ 10 —Ç—ã—Å. –ø–∏—Å–µ–º –Ω–∞—à–ª–æ—Å—å —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ –ø–æ–¥ –º–æ–π –∑–∞–ø—Ä–æ—Å.
```

 email_id | email_content | ts_description  
                                   
----------+---------------+-----------------------------------------------------
..............
------------------------------------------------------------------------------
      137 | Date: Tue, 16 Jan 2001 15:13:00 -0800 (PST) Subject: key westContent: thanks for your ca
ll about travel to key west. we were there for new yearafter a california visit. i will be back on j
an 24 for a week. it would begreat to see you there. if you need a place to stay my friend del brixe
yhas a room that might be available. let me know your dates etc...best to ted and you from us both, 
hal and doneley_________________________________________________________________Get your FREE downlo
ad of MSN Explorer at http://explorer.msn.com | '-0800':9 '00':8 '13':7 '15':6 '16':3 '2001':5 '24':
38 'avail':65 'back':35 'begreat':44 'best':72 'brixeyha':59 'california':30 'call':17 'date':1,70 '
del':58 'doneley':82 'download':86 'etc':71 'explor':89 'explorer.msn.com':91 'free':85 'friend':57 
'get':83 'hal':80 'jan':4,37 'key':12,21 'know':68 'let':66 'might':63 'msn':88 'need':51 'new':27 '
place':53 'pst':10 'room':61 'see':46 'stay':55 'subject':11 'ted':74 'thank':14 'travel':19 'tue':2
 'us':78 'visit':31 'week':41 'west':22 'westcont':13 'would':43 'yearaft':28
(1 —Å—Ç—Ä–æ–∫–∞)
```
–í–∏–¥–∏–º, —á—Ç–æ –≤—Å–µ–≥–æ –¥–≤–∞ —Å–ª–æ–≤–∞: jan –∏ key –≤—Å—Ç—Ä–µ—á–∞–ª–∏—Å—å –¥–≤–∞ —Ä–∞–∑–∞ (–ø—Ä–∏—á–µ–º
–∏–º–µ–Ω–Ω–æ –≤ –¥–∞–Ω–Ω–æ–º –≤–∏–¥–µ).

–ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã:
```SQL
EXPLAIN ANALYZE SELECT * FROM emails
WHERE ts_description @@ to_tsquery(
 'we & were & there & for & new & yearafter & a & california & visit' 
 );
```
```
                                                         QUERY PLAN                                                      
   
-------------------------------------------------------------------------------------------------------------------------
---
 Gather  (cost=1000.00..4764.22 rows=1 width=994) (actual time=214.725..215.920 rows=1 loops=1)
   Workers Planned: 1
   Workers Launched: 1
   ->  Parallel Seq Scan on emails  (cost=0.00..3764.12 rows=1 width=994) (actual time=112.344..204.386 rows=0 loops=2)
         Filter: (ts_description @@ to_tsquery('we & were & there & for & new & yearafter & a & california & visit'::text
))
         Rows Removed by Filter: 5000
 Planning time: 0.321 ms
 Execution time: 215.951 ms
(8 —Å—Ç—Ä–æ–∫)
```
–ó–∞–ø—Ä–æ—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–æ–ª–≥–æ.

–ü–æ–ø—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å —Ç–∏–ø–∞ GIN, –∫–æ—Ç–æ—Ä—ã–π –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](https://postgrespro.ru/docs/postgresql/12/textsearch-indexes) 
–ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫ –∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞.
```SQL
CREATE INDEX email_idx ON emails
USING GIN ( ts_description );

CREATE INDEX
```
–ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –Ω–µ–≥–æ:
```SQL
\d emails

                              –¢–∞–±–ª–∏—Ü–∞ "public.emails"
    –°—Ç–æ–ª–±–µ—Ü     |   –¢–∏–ø    | –ü—Ä–∞–≤–∏–ª–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ | –î–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å NULL | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 
----------------+----------+--------------------+-------------------+--------------
 email_id       | integer  |                    | not null          | 
 email_content  | text     |                    |                   | 
 ts_description | tsvector |                    |                   | 
–ò–Ω–¥–µ–∫—Å—ã:
    "emails_pkey" PRIMARY KEY, btree (email_id)
    "email_idx" gin (ts_description)
```

–ü–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:
```SQL
EXPLAIN ANALYZE SELECT * FROM emails
WHERE ts_description @@ to_tsquery(
 'we & were & there & for & new & yearafter & a & california & visit' 
 );
```

–í—ã–≤–æ–¥:
```
                                                           QUERY PLAN                                                    
       
-------------------------------------------------------------------------------------------------------------------------
-------
 Bitmap Heap Scan on emails  (cost=52.25..56.51 rows=1 width=994) (actual time=0.150..0.151 rows=1 loops=1)
   Recheck Cond: (ts_description @@ to_tsquery('we & were & there & for & new & yearafter & a & california & visit'::text
))
   Heap Blocks: exact=1
   ->  Bitmap Index Scan on email_idx  (cost=0.00..52.25 rows=1 width=0) (actual time=0.144..0.144 rows=1 loops=1)
         Index Cond: (ts_description @@ to_tsquery('we & were & there & for & new & yearafter & a & california & visit'::
text))
 Planning time: 0.378 ms
 Execution time: 0.186 ms
(7 —Å—Ç—Ä–æ–∫)
```
–í–∏–¥–∏–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ –±–æ–ª–µ–µ —á–µ–º –≤ 1000 —Ä–∞–∑! –î—É–º–∞—é —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å
–±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º –¥–∞–Ω–Ω—ã—Ö: —Ö–æ—Ç—è –ø–∏—Å–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–º–Ω–æ–≥–æ (10 —Ç—ã—Å.),
–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ.

---