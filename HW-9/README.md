## üë®üèª‚Äçüíª –î–ó ‚Ññ 9 –ì–ª–∞–≤–∞ 10. –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
1. [–ó–∞–¥–∞–Ω–∏–µ 3.](#–∑–∞–¥–∞–Ω–∏–µ_3)
2. [–ó–∞–¥–∞–Ω–∏–µ 6.](#–∑–∞–¥–∞–Ω–∏–µ_6)
3. [–ó–∞–¥–∞–Ω–∏–µ 8.](#–∑–∞–¥–∞–Ω–∏–µ_8)

### **–ó–∞–¥–∞–Ω–∏–µ 3.** <a name="–∑–∞–¥–∞–Ω–∏–µ_3"></a>

<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞–Ω–∏–µ üîΩ</summary>
–ó–∞–¥–∞–Ω–∏–µ:

–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `EXPLAIN` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, —Å–æ–¥–µ—Ä–∂–∞—â–µ–≥–æ –æ–±—â–µ–µ
—Ç–∞–±–ª–∏—á–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (`CTE`). –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∑–µ–ª –ø–ª–∞–Ω–∞, 
–æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ —ç—Ç–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –∫–∞–∫ –æ–Ω –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è. –£—á—Ç–∏—Ç–µ, —á—Ç–æ –æ–±—â–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ 
–≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è, —Ç. –µ. –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ –∏
—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏, –∞ –∑–∞—Ç–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è 
–≤ —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–∂–µ –∫ —ç—Ç–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
</details>

–û—Ç–≤–µ—Ç:

–í –∫–∞—á–µ—Å—Ç–≤–µ `CTE` —è –≤–æ–∑—å–º—É —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –î–ó, –≤ –∫–æ—Ç–æ—Ä–æ–º —è —Å—á–∏—Ç–∞–ª, 
—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –∑–∞–Ω—è—Ç–æ –∏ —Å–≤–æ–±–æ–¥–Ω–æ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ä–µ–π—Å–µ –≤–æ –≤—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª–æ—Å—å,
—á—Ç–æ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–Ω–∏–º–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π 
–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–π—Å–∞ ‚Äî –æ—Ü–µ–Ω–∏–≤–∞—Ç—å
—É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –º–µ—Å—Ç –∞–≤–∏–∞–ø–∞—Ä–∫–∞.

–ö –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ —è –¥–æ–±–∞–≤–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è .flight_id –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.

```SQL
with num_seats as (
select 
    aircraft_code,
    count(seat_no) as max_num
from seats
group by aircraft_code
),
cur_seats as (
select 
    flights.flight_id,
    aircraft_code,
    count(aircraft_code) as count
from flights
join boarding_passes on flights.flight_id = boarding_passes.flight_id
where flights.flight_id = 30625
group by aircraft_code, flights.flight_id
)
select 
    cur_seats.flight_id,
    num_seats.aircraft_code,
    max_num, 
    count as current_seats,
    max_num - count as seats_left
from num_seats
join cur_seats on num_seats.aircraft_code = cur_seats.aircraft_code;
```
–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
 flight_id | aircraft_code | max_num | current_seats | seats_left 
-----------+---------------+---------+---------------+------------
     30625 | 773           |     402 |            92 |        310
(1 —Å—Ç—Ä–æ–∫–∞)
```
–í–∏–¥–∏–º, —á—Ç–æ –Ω–∞ —ç—Ç–æ–º —Ä–µ–π—Å–µ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã –º–µ—Å—Ç –æ—Å—Ç–∞–ª–∏—Å—å —Å–≤–æ–±–æ–¥–Ω—ã–º–∏.

–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–µ–º –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `EXPLAIN`. –¢–∞–∫–∂–µ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ —è 
–¥–æ–±–∞–≤–ª—é –∫ –Ω–µ–π `ANALYZE`. –î–ª—è —á–∏—Å—Ç–æ—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª —Å–µ—Ä–≤–µ—Ä PostgreSQL.
```SQL
explain analyze
with num_seats as (
select 
    aircraft_code,
    count(seat_no) as max_num
from seats
group by aircraft_code
),
cur_seats as (
select 
    flights.flight_id,
    aircraft_code,
    count(aircraft_code) as count
from flights
join boarding_passes on flights.flight_id = boarding_passes.flight_id
where flights.flight_id = 30625
group by aircraft_code, flights.flight_id
)
select 
    cur_seats.flight_id,
    num_seats.aircraft_code,
    max_num, 
    count as current_seats,
    max_num - count as seats_left
from num_seats
join cur_seats on num_seats.aircraft_code = cur_seats.aircraft_code;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
                                                                             QUERY PLAN                                                                             
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hash Join  (cost=265.21..265.44 rows=1 width=44) (actual time=1.368..1.378 rows=1 loops=1)
   Hash Cond: (num_seats.aircraft_code = cur_seats.aircraft_code)
   CTE num_seats
     ->  HashAggregate  (cost=28.09..28.18 rows=9 width=12) (actual time=1.205..1.211 rows=9 loops=1)
           Group Key: seats.aircraft_code
           ->  Seq Scan on seats  (cost=0.00..21.39 rows=1339 width=7) (actual time=0.014..0.274 rows=1339 loops=1)
   CTE cur_seats
     ->  GroupAggregate  (cost=5.19..237.00 rows=1 width=16) (actual time=0.121..0.122 rows=1 loops=1)
           Group Key: flights.flight_id
           ->  Nested Loop  (cost=5.19..236.69 rows=61 width=8) (actual time=0.052..0.097 rows=92 loops=1)
                 ->  Index Scan using flights_pkey on flights  (cost=0.29..8.31 rows=1 width=8) (actual time=0.015..0.016 rows=1 loops=1)
                       Index Cond: (flight_id = 30625)
                 ->  Bitmap Heap Scan on boarding_passes  (cost=4.90..227.77 rows=61 width=4) (actual time=0.032..0.044 rows=92 loops=1)
                       Recheck Cond: (flight_id = 30625)
                       Heap Blocks: exact=1
                       ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.88 rows=61 width=0) (actual time=0.022..0.022 rows=92 loops=1)
                             Index Cond: (flight_id = 30625)
   ->  CTE Scan on num_seats  (cost=0.00..0.18 rows=9 width=24) (actual time=1.209..1.220 rows=9 loops=1)
   ->  Hash  (cost=0.02..0.02 rows=1 width=28) (actual time=0.132..0.133 rows=1 loops=1)
         Buckets: 1024  Batches: 1  Memory Usage: 9kB
         ->  CTE Scan on cur_seats  (cost=0.00..0.02 rows=1 width=28) (actual time=0.125..0.126 rows=1 loops=1)
 Planning time: 0.531 ms
 Execution time: 1.531 ms
(23 —Å—Ç—Ä–æ–∫–∏)
```

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ:
```
                                                                             QUERY PLAN                                                                             
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hash Join  (cost=265.21..265.44 rows=1 width=44) (actual time=0.513..0.517 rows=1 loops=1)
   Hash Cond: (num_seats.aircraft_code = cur_seats.aircraft_code)
   CTE num_seats
     ->  HashAggregate  (cost=28.09..28.18 rows=9 width=12) (actual time=0.447..0.449 rows=9 loops=1)
           .......
   CTE cur_seats
     ->  GroupAggregate  (cost=5.19..237.00 rows=1 width=16) (actual time=0.049..0.050 rows=1 loops=1)
           ......
   ->  CTE Scan on num_seats  (cost=0.00..0.18 rows=9 width=24) (actual time=0.449..0.453 rows=9 loops=1)
           ......
         ->  CTE Scan on cur_seats  (cost=0.00..0.02 rows=1 width=28) (actual time=0.050..0.051 rows=1 loops=1)
 Planning time: 0.271 ms
 Execution time: 0.584 ms
(23 —Å—Ç—Ä–æ–∫–∏)
```

–í–æ-–ø–µ—Ä–≤—ã—Ö, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º, —á—Ç–æ –≤–æ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å CTE,
–≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ, –∞ —Ç–∞–∫–∂–µ —Å–∞–º –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –±—ã—Å—Ç—Ä–µ–µ, –Ω–µ—Å–º–æ—Ç—Ä—è
–Ω–∞ —Ç–æ, —á—Ç–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–µ —á–∏—Å–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é (cost) –Ω–µ –º–µ–Ω—è–ª–æ—Å—å.

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∑–µ–ª –ø–ª–∞–Ω–∞, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ —ç—Ç–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –∫–∞–∫ –æ–Ω –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è. 

–í–æ-–≤—Ç–æ—Ä—ã—Ö, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ—Å—Ç–æ `CTE` –≤ –ø–ª–∞–Ω–µ –∑–∞–ø—Ä–æ—Å–∞. –í–∏–¥–∏–º, —á—Ç–æ –≤ –ø–ª–∞–Ω–µ –µ—Å—Ç—å 
–Ω–µ—Å–∫–æ–ª—å–∫–æ —É–∑–ª–æ–≤, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ `CTE`, –∫–∞–∫ –∏ –≤ –º–æ–µ–º –∑–∞–ø—Ä–æ—Å–µ. "–í–µ—Ä—à–∏–Ω—ã"
`CTE` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ —Å–∞–º—ã—Ö –≤–µ—Ä—Ö–Ω–∏—Ö —É—Ä–æ–≤–Ω—è—Ö –ø–ª–∞–Ω–∞. –≠—Ç–æ –ª–æ–≥–∏—á–Ω–æ, –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —á—Ç–æ
–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∏—Ö –∫–∞–∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.
–¢–∞–∫–∂–µ –º–æ–∂–µ–º –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–æ–≤ —Å `CTE` –º—ã –º–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å —Ç–∏–ø–∏—á–Ω–æ–µ
–ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏, —Ç.–µ. —Å–∫–æ—Ä–µ–µ
–≤—Å–µ–≥–æ –Ω–∏—á–µ–≥–æ –±—ã –Ω–µ –æ—Ç–ª–∏—á–∞–ª–æ—Å—å, –µ—Å–ª–∏ –±—ã –º—ã –æ—Ç–¥–µ–ª—å–Ω–æ –¥–µ–ª–∞–ª–∏ —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å.
–ú–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ `CTE` –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–ü–æ–ø—Ä–æ–±—É—é –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–ª–∞–Ω –∫–∞–∂–¥–æ–≥–æ –∏–∑ –¥–≤—É—Ö `CTE`-–∑–∞–ø—Ä–æ—Å–∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏.
–í—ã–≤–æ–∂—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
HashAggregate  (cost=28.09..28.18 rows=9 width=12) (actual time=0.502..0.505 rows=9 loops=1)
   Group Key: aircraft_code
   ->  Seq Scan on seats  (cost=0.00..21.39 rows=1339 width=7) (actual time=0.011..0.116 rows=1339 loops=1)
 Planning time: 0.076 ms
 Execution time: 0.538 ms
(5 —Å—Ç—Ä–æ–∫)

 GroupAggregate  (cost=5.19..237.00 rows=1 width=16) (actual time=0.102..0.103 rows=1 loops=1)
   Group Key: flights.flight_id
   ->  Nested Loop  (cost=5.19..236.69 rows=61 width=8) (actual time=0.050..0.077 rows=92 loops=1)
         ->  Index Scan using flights_pkey on flights  (cost=0.29..8.31 rows=1 width=8) (actual time=0.015..0.016 rows=1 loops=1)
               Index Cond: (flight_id = 30625)
         ->  Bitmap Heap Scan on boarding_passes  (cost=4.90..227.77 rows=61 width=4) (actual time=0.031..0.041 rows=92 loops=1)
               Recheck Cond: (flight_id = 30625)
               Heap Blocks: exact=1
               ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.88 rows=61 width=0) (actual time=0.021..0.021 rows=92 loops=1)
                     Index Cond: (flight_id = 30625)
 Planning time: 0.252 ms
 Execution time: 0.164 ms
(12 —Å—Ç—Ä–æ–∫)
```

–í–∏–¥–∏–º, —á—Ç–æ –ø–ª–∞–Ω—ã –Ω–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç "–æ–±—â–µ–≥–æ –ø–ª–∞–Ω–∞". –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ
—á–∏—Å–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ç–∞–∫–∂–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.

---

### **–ó–∞–¥–∞–Ω–∏–µ 6.** <a name="–∑–∞–¥–∞–Ω–∏–µ_6"></a>

<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞–Ω–∏–µ üîΩ</summary>
–ó–∞–¥–∞–Ω–∏–µ:

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `EXPLAIN` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ 
–∫–∞–∫–∞—è-–Ω–∏–±—É–¥—å –∏–∑ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ù–∞–π–¥–∏—Ç–µ –≤ –ø–ª–∞–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —É–∑–µ–ª —Å 
–∏–º–µ–Ω–µ–º `WindowAgg`. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç—å, –ø–æ—á–µ–º—É –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç 
—É—Ä–æ–≤–µ–Ω—å –≤ –ø–ª–∞–Ω–µ.
</details>

–û—Ç–≤–µ—Ç:

–î–æ–ø—É—Å—Ç–∏–º, –º—ã —Ö–æ—Ç–∏–º —Ä–µ—à–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É: –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π —Ä–µ–π—Å –∏–∑ 
–î–æ–º–æ–¥–µ–¥–æ–≤–æ (–ø–æ —Ä–µ–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–º–æ–ª–µ—Ç–∞. –î–ª—è —ç—Ç–æ–≥–æ
–ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥–æ–π–¥–µ—Ç –æ–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `ROW_NUMBER()`.
–¢–∞–∫–∂–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —è —Å–¥–µ–ª–∞—é –Ω–æ–º–∏–Ω–∞–ª—å–Ω—ã–π 
`CTE`-–∑–∞–ø—Ä–æ—Å, –Ω–æ –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω —Ç—Ä–∞—Ç–∏—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–µ–±—è.

–ò—Ç–∞–∫,–∑–∞–ø—Ä–æ—Å:
```SQL
with cte as 
(
    select 
        a.model,
        --f.*
        f.flight_no,
        f.departure_airport,
        f.arrival_airport,
        f.actual_departure,
        f.actual_arrival,
        ROW_NUMBER() 
        OVER (PARTITION BY f.aircraft_code ORDER BY actual_departure ASC) as rn
    from flights f
    join aircrafts a on f.aircraft_code = a.aircraft_code
    where departure_airport = 'DME'
)
select * from cte
where rn = 1;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–µ–¥—É—é—â–∏–π:
```
        model        | flight_no | departure_airport | arrival_airport |    actual_departure    |     actual_arrival     | rn 
---------------------+-----------+-------------------+-----------------+------------------------+------------------------+----
 Airbus A319-100     | PG0134    | DME               | BTK             | 2016-09-13 08:54:00+03 | 2016-09-13 14:05:00+03 |  1
 Airbus A321-200     | PG0405    | DME               | LED             | 2016-09-13 08:44:00+03 | 2016-09-13 09:39:00+03 |  1
 Boeing 737-300      | PG0210    | DME               | MRV             | 2016-09-13 17:01:00+03 | 2016-09-13 18:50:00+03 |  1
 Boeing 767-300      | PG0517    | DME               | SCW             | 2016-09-13 09:35:00+03 | 2016-09-13 10:57:00+03 |  1
 Boeing 777-300      | PG0222    | DME               | OVB             | 2016-09-13 10:06:00+03 | 2016-09-13 13:31:00+03 |  1
 Cessna 208 Caravan  | PG0335    | DME               | JOK             | 2016-09-13 08:31:00+03 | 2016-09-13 10:37:00+03 |  1
 Bombardier CRJ-200  | PG0341    | DME               | PES             | 2016-09-13 09:52:00+03 | 2016-09-13 10:58:00+03 |  1
 Sukhoi SuperJet-100 | PG0239    | DME               | HMA             | 2016-09-13 08:05:00+03 | 2016-09-13 10:39:00+03 |  1
(8 —Å—Ç—Ä–æ–∫)
```

–ú–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –≤ –Ω–∞—à–µ–π –ë–î –Ω–µ—Ç —Ä–µ–π—Å–æ–≤ —É —Å–∞–º–æ–ª–µ—Ç–∞ Airbus A320-200 –∏–∑ –î–æ–º–æ–¥–µ–¥–æ–≤–æ
(–∫–∞–∫ –∏ –≤ —Ü–µ–ª–æ–º –≤–æ –≤–µ—Å—Ö –ø–æ–ª–µ—Ç–∞—Ö).

–ï—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∑–∞–ø—Ä–æ—Å—É –∫–æ–º–∞–Ω–¥—ã `EXPLAIN ANALYZE`, –ø–æ–ª—É—á–∏—Ç—Å—è:
```
                                                              QUERY PLAN                                                              
--------------------------------------------------------------------------------------------------------------------------------------
 CTE Scan on cte  (cost=1071.12..1143.44 rows=16 width=116) (actual time=8.958..12.158 rows=8 loops=1)
   Filter: (rn = 1)
   Rows Removed by Filter: 3209
   CTE cte
     ->  WindowAgg  (cost=1006.84..1071.12 rows=3214 width=83) (actual time=8.954..10.636 rows=3217 loops=1)
           ->  Sort  (cost=1006.84..1014.88 rows=3214 width=67) (actual time=8.947..9.090 rows=3217 loops=1)
                 Sort Key: f.aircraft_code, f.actual_departure
                 Sort Method: quicksort  Memory: 449kB
                 ->  Hash Join  (cost=1.20..819.62 rows=3214 width=67) (actual time=0.025..7.145 rows=3217 loops=1)
                       Hash Cond: (f.aircraft_code = a.aircraft_code)
                       ->  Seq Scan on flights f  (cost=0.00..806.01 rows=3214 width=35) (actual time=0.011..5.953 rows=3217 loops=1)
                             Filter: (departure_airport = 'DME'::bpchar)
                             Rows Removed by Filter: 29904
                       ->  Hash  (cost=1.09..1.09 rows=9 width=48) (actual time=0.010..0.010 rows=9 loops=1)
                             Buckets: 1024  Batches: 1  Memory Usage: 9kB
                             ->  Seq Scan on aircrafts a  (cost=0.00..1.09 rows=9 width=48) (actual time=0.003..0.005 rows=9 loops=1)
 Planning time: 0.185 ms
 Execution time: 12.264 ms
(18 —Å—Ç—Ä–æ–∫)
```

–í–∏–¥–∏–º —É–∑–µ–ª —Å –∏–º–µ–Ω–µ–º `WindowAgg`. –û–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É `CTE` (—Ç.–µ. –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º).
–î—É–º–∞—é —ç—Ç–æ —Ç–∞–∫, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —É–∂–µ –∫ –∏—Ç–æ–≥–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ:
–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–π –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–π. –ö —Ç–æ–º—É –∂–µ, –≤—ã–±–æ—Ä–∫—É –µ—â–µ –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ (–æ–∫–Ω–∞)
–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –Ω–∏–º.

---

### **–ó–∞–¥–∞–Ω–∏–µ 8.** <a name="–∑–∞–¥–∞–Ω–∏–µ_8"></a>

<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–¥–∞–Ω–∏–µ üîΩ</summary>
–ó–∞–¥–∞–Ω–∏–µ:

–ó–∞–º–µ–Ω–∞ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü —è–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–∏–º –∏–∑
—Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –º—ã –∑–∞–¥–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å–æ–º: —Å–∫–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç 
—Å–∞–º–æ–ª–µ—Ç—ã –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞? –ü—Ä–∏ —ç—Ç–æ–º –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–µ—Å—Ç–æ —Ç–∞–∫–∞—è
—Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ —Å–∞–º–æ–ª–µ—Ç—ã –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Ç–∏–ø–∞ –Ω–µ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ 
–º–∞—Ä—à—Ä—É—Ç–∞. –ü–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ¬´–ú–∞—Ä—à—Ä—É—Ç—ã¬ª
(`routes`), –Ω–æ –∏ —Ç–∞–±–ª–∏—Ü—É ¬´–°–∞–º–æ–ª–µ—Ç—ã¬ª (`aircrafts`).

–≠—Ç–æ –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞, –≤ –Ω–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å.
```SQL
EXPLAIN ANALYZE
SELECT a.aircraft_code AS a_code,
a.model,
( SELECT count( r.aircraft_code )
FROM routes r
WHERE r.aircraft_code = a.aircraft_code
) AS num_routes
FROM aircrafts a
GROUP BY 1, 2
ORDER BY 3 DESC;
```

–ê –≤ —ç—Ç–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å —Ä–∞—Å–∫—Ä—ã—Ç –∏ –∑–∞–º–µ–Ω–µ–Ω –≤–Ω–µ—à–Ω–∏–º
—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º:
```SQL
EXPLAIN ANALYZE
SELECT a.aircraft_code AS a_code,
a.model,
count( r.aircraft_code ) AS num_routes
FROM aircrafts a
LEFT OUTER JOIN routes r
ON r.aircraft_code = a.aircraft_code
GROUP BY 1, 2
ORDER BY 3 DESC;
```

–ü—Ä–∏—á–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ —Ç–æ–º, —á—Ç–æ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏—Å—å 
–º–æ–¥–µ–ª—å —Å–∞–º–æ–ª–µ—Ç–∞, –Ω–µ –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–∞—è –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞, –∏ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–≤–Ω–µ—à–Ω–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –æ–Ω–∞ –≤–æ–æ–±—â–µ –Ω–µ –ø–æ–ø–∞–¥–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â—É—é –≤—ã–±–æ—Ä–∫—É.

–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—ã—Ç–∞–π—Ç–µ—Å—å –Ω–∞–π—Ç–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
—Ä–∞–∑–ª–∏—á–∏—è–º –≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω—É—é
–∫–∞—Ä—Ç–∏–Ω—É, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –ü–æ—Å–∫–æ–ª—å–∫—É —Ç–∞–±–ª–∏—Ü—ã, 
—É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö, –Ω–µ–±–æ–ª—å—à–∏–µ, —Ç–æ —Ä–∞–∑–ª–∏—á–∏–µ –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –∑–∞—Ç—Ä–∞—Ç–∞–º –≤—Ä–µ–º–µ–Ω–∏
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º. –ù–æ –µ—Å–ª–∏ –±—ã —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –±—ã–ª–æ
–±–æ–ª—å—à–∏–º, —Ç–æ —ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞ –º–æ–≥–ª–∞ –æ–∫–∞–∑–∞—Ç—å—Å—è –∑–∞–º–µ—Ç–Ω–æ–π.

–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –ø–∞—Ä—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ¬´–ê–≤–∏–∞–ø–µ—Ä–µ–≤–æ–∑–∫–∏¬ª. 
–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –≤–∞—à–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.
</details>

–û—Ç–≤–µ—Ç:

–ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–º–µ—Ä–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–ª–µ–¥—É—é—â–∏—Ö –¥–≤—É—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —É—Å—Ä–µ–¥–Ω–∏–≤ 5 
–∑–∞–ø—É—Å–∫–æ–≤ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –ø–ª–∞–Ω—ã –∏—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:

```SQL
EXPLAIN ANALYZE
SELECT a.aircraft_code AS a_code,
a.model,
( SELECT count( r.aircraft_code )
FROM routes r
WHERE r.aircraft_code = a.aircraft_code
) AS num_routes
FROM aircrafts a
GROUP BY 1, 2
ORDER BY 3 DESC;
```
```SQL
EXPLAIN ANALYZE
SELECT a.aircraft_code AS a_code,
a.model,
count( r.aircraft_code ) AS num_routes
FROM aircrafts a
LEFT OUTER JOIN routes r
ON r.aircraft_code = a.aircraft_code
GROUP BY 1, 2
ORDER BY 3 DESC;
```

–°–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: 
1. 12.264
2. 1.664
3. 2.215
4. 1.293
5. 2.841

–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 4.055 –º—Å (–±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ ‚Äî 2.003 –º—Å).

–ü–ª–∞–Ω –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:
```
                                                       QUERY PLAN                                                        
-------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=236.31..236.34 rows=9 width=56) (actual time=2.763..2.765 rows=9 loops=1)
   Sort Key: ((SubPlan 1)) DESC
   Sort Method: quicksort  Memory: 25kB
   ->  HashAggregate  (cost=1.11..236.17 rows=9 width=56) (actual time=0.401..2.745 rows=9 loops=1)
         Group Key: a.aircraft_code
         ->  Seq Scan on aircrafts a  (cost=0.00..1.09 rows=9 width=48) (actual time=0.008..0.010 rows=9 loops=1)
         SubPlan 1
           ->  Aggregate  (cost=26.10..26.11 rows=1 width=8) (actual time=0.299..0.299 rows=1 loops=9)
                 ->  Seq Scan on routes r  (cost=0.00..25.88 rows=89 width=4) (actual time=0.058..0.281 rows=79 loops=9)
                       Filter: (aircraft_code = a.aircraft_code)
                       Rows Removed by Filter: 631
 Planning time: 0.239 ms
 Execution time: 2.841 ms
(13 —Å—Ç—Ä–æ–∫)
```

–°–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: 
1. 1.106
2. 1.096
3. 1.424 
4. 1.108
5. 0.693

–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: 1.085 –º—Å.

–ü–ª–∞–Ω –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:
```
                                                          QUERY PLAN                                                          
------------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=31.83..31.85 rows=9 width=56) (actual time=0.650..0.651 rows=9 loops=1)
   Sort Key: (count(r.aircraft_code)) DESC
   Sort Method: quicksort  Memory: 25kB
   ->  HashAggregate  (cost=31.60..31.69 rows=9 width=56) (actual time=0.636..0.639 rows=9 loops=1)
         Group Key: a.aircraft_code
         ->  Hash Right Join  (cost=1.20..28.05 rows=710 width=52) (actual time=0.048..0.416 rows=711 loops=1)
               Hash Cond: (r.aircraft_code = a.aircraft_code)
               ->  Seq Scan on routes r  (cost=0.00..24.10 rows=710 width=4) (actual time=0.004..0.094 rows=710 loops=1)
               ->  Hash  (cost=1.09..1.09 rows=9 width=48) (actual time=0.039..0.039 rows=9 loops=1)
                     Buckets: 1024  Batches: 1  Memory Usage: 9kB
                     ->  Seq Scan on aircrafts a  (cost=0.00..1.09 rows=9 width=48) (actual time=0.017..0.019 rows=9 loops=1)
 Planning time: 0.139 ms
 Execution time: 0.693 ms
(13 —Å—Ç—Ä–æ–∫)
```

–ü—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –¥–≤—É—Ö –ø–ª–∞–Ω–æ–≤ –≤–∏–¥–∏–º –±–æ–ª—å—à—É—é —Ä–∞–∑–Ω–∏—Ü—É –≤ –∑–∞—Ç—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö
—Ä–µ—Å—É—Ä—Å–∞—Ö: –ø–æ—á—Ç–∏ –≤ 10 —Ä–∞–∑. –ü–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –≤–∏–¥–∏–º —Ä–∞–∑–Ω–∏—Ü—É –≤ 
—Å—Ä–µ–¥–Ω–µ–º –≤—Ä–µ–º–µ–Ω–∏ –≤ 4 —Ä–∞–∑–∞, –ø—Ä–∏ —ç—Ç–æ–º –≤ –ø–µ—Ä–≤–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ —Å –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏
—Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ–∫–æ–ª–æ 12 –º—Å), 
–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ ‚Äî –≤—Å–µ–≥–æ –≤ 2 —Ä–∞–∑–∞ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –≤ —Å—Ä–µ–¥–Ω–µ–º (–æ–∫–æ–ª–æ 2 –º—Å).

–ü—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ, —Ç–∞–∫–∞—è –±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –∑–∞—Å—á–µ—Ç —Ç–æ–≥–æ, —á—Ç–æ
–≤ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –Ω–∞–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è 9 —Ä–∞–∑ (–ø–æ —á–∏—Å–ª—É —Å–∞–º–æ–ª–µ—Ç–æ–≤) 
–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ —Ä–µ–π—Å—ã, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å —á–∏—Å–ª–æ
—Å—Ç—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ (–ø–æ —Å—É—Ç–∏, –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç—Ä–æ–∫).

–≠—Ç–æ –∑–∞–º–µ—Ç–Ω–æ –≤ –ø–µ—Ä–≤–æ–º –ø–ª–∞–Ω–µ (`loops=9`):
```
Seq Scan on routes r  (cost=0.00..25.88 rows=89 width=4) (actual time=0.058..0.281 rows=79 loops=9)
                       Filter: (aircraft_code = a.aircraft_code)
                       Rows Removed by Filter: 631
```

–í–æ –≤—Ç–æ—Ä–æ–º –ø–ª–∞–Ω–µ –º—ã –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π —Å–∞–º–æ–ª–µ—Ç–æ–≤
—Å –ø–æ–º–æ—â—å—é —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (`Hash Right Join`), –∏ –∑–∞—Ç–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º
–¥–∞–Ω–Ω—ã–µ –ø–æ `aircraft_code`, –±–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ 9 —Ä–∞–∑ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ 
—Ç–∞–±–ª–∏—Ü–µ `routes`.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è –≤–∞–∂–Ω—ã–º –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ `GROUP BY` 
–≤ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–±—ã—Ç–æ—á–Ω—ã–º, –ø–æ—Å–∫–æ–ª—å–∫—É –∑–∞–ø—Ä–æ—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ 
–±–µ–∑ –Ω–µ–≥–æ, —Ç.–∫. –≤–æ "–≤–Ω–µ—à–Ω–µ–º" –∑–∞–ø—Ä–æ—Å–µ –Ω–∞–º —É–∂–µ –Ω–µ –Ω—É–∂–Ω–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:
```SQL
SELECT a.aircraft_code AS a_code,
a.model,
( SELECT count( r.aircraft_code )
FROM routes r
WHERE r.aircraft_code = a.aircraft_code
) AS num_routes
FROM aircrafts a
ORDER BY 3 DESC;

 a_code |        model        | num_routes 
--------+---------------------+------------
 CR2    | Bombardier CRJ-200  |        232
 CN1    | Cessna 208 Caravan  |        170
 SU9    | Sukhoi SuperJet-100 |        158
 319    | Airbus A319-100     |         46
 733    | Boeing 737-300      |         36
 321    | Airbus A321-200     |         32
 763    | Boeing 767-300      |         26
 773    | Boeing 777-300      |         10
 320    | Airbus A320-200     |          0
(9 —Å—Ç—Ä–æ–∫)
```

–û–¥–Ω–∞–∫–æ —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç—Ä–µ–±—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è,
–ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –≤—Å–µ –µ—â–µ 9 —Ä–∞–∑ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ `routes`:
```SQL
EXPLAIN ANALYZE
......

                                                       QUERY PLAN                                                        
-------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=236.20..236.22 rows=9 width=56) (actual time=1.250..1.252 rows=9 loops=1)
   Sort Key: ((SubPlan 1)) DESC
   Sort Method: quicksort  Memory: 25kB
   ->  Seq Scan on aircrafts a  (cost=0.00..236.06 rows=9 width=56) (actual time=0.177..1.240 rows=9 loops=1)
         SubPlan 1
           ->  Aggregate  (cost=26.10..26.11 rows=1 width=8) (actual time=0.136..0.136 rows=1 loops=9)
                 ->  Seq Scan on routes r  (cost=0.00..25.88 rows=89 width=4) (actual time=0.022..0.127 rows=79 loops=9)
                       Filter: (aircraft_code = a.aircraft_code)
                       Rows Removed by Filter: 631
 Planning time: 0.092 ms
 Execution time: 1.282 ms
(11 —Å—Ç—Ä–æ–∫)
```

* –ë—ã–ª–æ:  `cost=236.31..236.34`
* –°—Ç–∞–ª–æ: `cost=236.20..236.22`

---

–í –∫–∞—á–µ—Å—Ç–≤–µ –µ—â–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º 
–ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —è —Ä–µ—à–∏–ª –≤–∑—è—Ç—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è 
—Ç–µ–∫—É—â–µ–≥–æ –î–ó, –Ω–µ–º–Ω–æ–≥–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –µ–≥–æ, —á—Ç–æ–±—ã –æ–Ω —Ä–µ—à–∞–ª —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É,
–∫–æ—Ç–æ—Ä–∞—è –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ–π:
—Å—á–∏—Ç–∞–µ–º –¥–æ–ª—é –≤—ã–¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–∞–¥–æ—á–Ω—ã—Ö —Ç–∞–ª–æ–Ω–æ–≤ –æ—Ç –º–∞–∫—Å. —á–∏—Å–ª–∞ –º–µ—Å—Ç –ø–æ –∫–∞–∂–¥–æ–º—É 
–∑–∞–≤–µ—Ä—à–∏–≤—à–µ–º—É—Å—è —Ä–µ–π—Å—É (—Å–æ —Å—Ç–∞—Ç—É—Å–æ–º Arrived). –ü—Ä–æ–ø—É—Å—Ç–∏–º –∑–∞–≤–µ—Ä—à–∏–≤—à–∏–µ—Å—è —Ä–µ–π—Å—ã
—Å 0 –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ (–Ω–∞ —É–¥–∏–≤–ª–µ–Ω–∏–µ –∏—Ö –æ–∫–∞–∑–∞–ª–æ—Å—å –æ–∫–æ–ª–æ 2/3), –ø–æ—Å–∫–æ–ª—å–∫—É
–≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ. 

–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –Ω–∞–º –≥—Ä–∞–º–æ—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –∑–∞–ø–∞—Å
—Ç–æ–ø–ª–∏–≤–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ–π—Å, –∞ —Ç–∞–∫–∂–µ –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫ —É—Ç–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞—à
–∞–≤–∏–∞–ø–∞—Ä–∫.

–Ø –Ω–µ–º–Ω–æ–≥–æ –¥–æ—Ä–∞–±–æ—Ç–∞–ª –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
```SQL
-- good
with num_seats as (
select 
    aircraft_code,
    count(seat_no) as max_num
from seats
group by aircraft_code
)
select 
    flights.flight_id,
    num_seats.aircraft_code,
    num_seats.max_num,
    count(*) as count_num,
    num_seats.max_num - count(*) as left,
    round(( count(*)::numeric / num_seats.max_num::numeric ) * 100, 2) as utilization
from flights
right outer join boarding_passes on flights.flight_id = boarding_passes.flight_id
right outer join num_seats on flights.aircraft_code = num_seats.aircraft_code
where flights.status = 'Arrived'
group by num_seats.aircraft_code, num_seats.max_num, flights.flight_id
order by flights.flight_id
;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```
 flight_id | aircraft_code | max_num | count_num | left | utilization 
-----------+---------------+---------+-----------+------+-------------
         1 | 321           |     170 |        79 |   91 |       46.47
         2 | 321           |     170 |       101 |   69 |       59.41
         3 | 321           |     170 |        97 |   73 |       57.06
        17 | 321           |     170 |       101 |   69 |       59.41
        18 | 321           |     170 |        96 |   74 |       56.47
        21 | 321           |     170 |        85 |   85 |       50.00
        22 | 321           |     170 |         1 |  169 |        0.59
        25 | 321           |     170 |       115 |   55 |       67.65
        26 | 321           |     170 |        90 |   80 |       52.94
        27 | 321           |     170 |        92 |   78 |       54.12
...........
```

–°–µ–π—á–∞—Å –æ–Ω –¥–æ–≤–æ–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É —Å–æ–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 
–≤ –æ–¥–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ –∏ –¥–∞–ª–µ–µ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö –Ω—É–∂–Ω—ã–º –Ω–∞–º –æ–±—Ä–∞–∑–æ–º. –ü—Ä–∏ —ç—Ç–æ–º 
–º–∞–∫—Å. —á–∏—Å–ª–æ –º–µ—Å—Ç –∑–∞—Ä–∞–Ω–µ–µ –æ–¥–∏–Ω —Ä–∞–∑ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ `CTE`.

–í–æ—Ç –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø–ª–∞–Ω —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
```SQL
EXPLAIN ANALYZE
with num_seats as (
select 
    aircraft_code,
    count(seat_no) as max_num
from seats
group by aircraft_code
)
select 
    --cur_seats.flight_id,
    flights.flight_id,
    num_seats.aircraft_code,
    num_seats.max_num,
    count(*) as count_num,
    num_seats.max_num - count(*) as left,
    round(( count(*)::numeric / num_seats.max_num::numeric ) * 100, 2) as utilization
from flights
right outer join boarding_passes on flights.flight_id = boarding_passes.flight_id
right outer join num_seats on flights.aircraft_code = num_seats.aircraft_code
where flights.status = 'Arrived'
group by num_seats.aircraft_code, num_seats.max_num, flights.flight_id
order by flights.flight_id
;
```
```
                                                                QUERY PLAN                                                                
------------------------------------------------------------------------------------------------------------------------------------------
 GroupAggregate  (cost=49951.70..58822.59 rows=150273 width=76) (actual time=577.662..777.627 rows=11438 loops=1)
   Group Key: flights.flight_id, num_seats.aircraft_code, num_seats.max_num
   CTE num_seats
     ->  HashAggregate  (cost=28.09..28.18 rows=9 width=12) (actual time=0.757..0.761 rows=9 loops=1)
           Group Key: seats.aircraft_code
           ->  Seq Scan on seats  (cost=0.00..21.39 rows=1339 width=7) (actual time=0.007..0.161 rows=1339 loops=1)
   ->  Sort  (cost=49923.53..50654.11 rows=292232 width=28) (actual time=577.624..652.689 rows=574830 loops=1)
         Sort Key: flights.flight_id, num_seats.aircraft_code, num_seats.max_num
         Sort Method: external merge  Disk: 14656kB
         ->  Hash Join  (cost=1244.60..16400.60 rows=292232 width=28) (actual time=21.116..247.489 rows=574830 loops=1)
               Hash Cond: (boarding_passes.flight_id = flights.flight_id)
               ->  Seq Scan on boarding_passes  (cost=0.00..10059.86 rows=579686 width=4) (actual time=0.010..59.847 rows=579686 loops=1)
               ->  Hash  (cost=1035.89..1035.89 rows=16697 width=28) (actual time=21.001..21.003 rows=16707 loops=1)
                     Buckets: 32768  Batches: 1  Memory Usage: 1040kB
                     ->  Hash Join  (cost=0.29..1035.89 rows=16697 width=28) (actual time=0.791..16.289 rows=16707 loops=1)
                           Hash Cond: (flights.aircraft_code = num_seats.aircraft_code)
                           ->  Seq Scan on flights  (cost=0.00..806.01 rows=16697 width=8) (actual time=0.005..9.385 rows=16707 loops=1)
                                 Filter: ((status)::text = 'Arrived'::text)
                                 Rows Removed by Filter: 16414
                           ->  Hash  (cost=0.18..0.18 rows=9 width=24) (actual time=0.774..0.775 rows=9 loops=1)
                                 Buckets: 1024  Batches: 1  Memory Usage: 9kB
                                 ->  CTE Scan on num_seats  (cost=0.00..0.18 rows=9 width=24) (actual time=0.760..0.768 rows=9 loops=1)
 Planning time: 0.574 ms
 Execution time: 780.417 ms
(24 —Å—Ç—Ä–æ–∫–∏)
```

–í–∏–¥–∏–º, —á—Ç–æ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ü–∏–∫–ª.

–¢–µ–ø–µ—Ä—å "–∏—Å–ø–æ—Ä—Ç–∏–º" —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å, –¥–æ–±–∞–≤–∏–≤ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è
—Å–∞–º–æ–ª–µ—Ç–æ–≤ (aircraft_code) –∏ —Ä–µ–π—Å–æ–≤ (flight_id), —á—Ç–æ–±—ã –Ω–∞—Ö–æ–¥–∏—Ç—å
–º–∞–∫—Å. —á–∏—Å–ª–æ –º–µ—Å—Ç –∏ —á–∏—Å–ª–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–∞–¥–æ—á–Ω—ã—Ö —Ç–∞–ª–æ–Ω–æ–≤:
```SQL
-- bad
select
    flights.flight_id,
    flights.aircraft_code,
    ( select count(seat_no) 
      from seats
      where seats.aircraft_code = flights.aircraft_code
    ) as max_num,
    ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
    ) as count_num,
    ( select count(seat_no) 
      from seats
      where seats.aircraft_code = flights.aircraft_code
    )
     - 
    ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
    ) as left,
    round(( ( select count(*) 
              from boarding_passes
              where flights.flight_id = boarding_passes.flight_id
     )::numeric / ( select count(seat_no) 
                    from seats
                    where seats.aircraft_code = flights.aircraft_code
     )::numeric ) * 100, 2) as utilization
from flights
where flights.status = 'Arrived'
and ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
     ) > 0
order by flights.flight_id
;
```

–ú–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ —Ç–∞–∫–æ–π –∂–µ:
```
 flight_id | aircraft_code | max_num | count_num | left | utilization 
-----------+---------------+---------+-----------+------+-------------
         1 | 321           |     170 |        79 |   91 |       46.47
         2 | 321           |     170 |       101 |   69 |       59.41
         3 | 321           |     170 |        97 |   73 |       57.06
        17 | 321           |     170 |       101 |   69 |       59.41
        18 | 321           |     170 |        96 |   74 |       56.47
        21 | 321           |     170 |        85 |   85 |       50.00
        22 | 321           |     170 |         1 |  169 |        0.59
        25 | 321           |     170 |       115 |   55 |       67.65
        26 | 321           |     170 |        90 |   80 |       52.94
        27 | 321           |     170 |        92 |   78 |       54.12
...............
```

–ù–æ —Å–∞–º –∑–∞–ø—Ä–æ—Å –≥–æ—Ä–∞–∑–¥–æ –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π:
```SQL
EXPLAIN ANALYZE
select
    flights.flight_id,
    flights.aircraft_code,
    ( select count(seat_no) 
      from seats
      where seats.aircraft_code = flights.aircraft_code
    ) as max_num,
    ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
    ) as count_num,
    ( select count(seat_no) 
      from seats
      where seats.aircraft_code = flights.aircraft_code
    )
     - 
    ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
    ) as left,
    round(( ( select count(*) 
              from boarding_passes
              where flights.flight_id = boarding_passes.flight_id
     )::numeric / ( select count(seat_no) 
                    from seats
                    where seats.aircraft_code = flights.aircraft_code
     )::numeric ) * 100, 2) as utilization
from flights
where flights.status = 'Arrived'
and ( select count(*) 
      from boarding_passes
      where flights.flight_id = boarding_passes.flight_id
     ) > 0
order by flights.flight_id
;
```
```
                                                                            QUERY PLAN                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using flights_pkey on flights  (cost=0.29..12138437.10 rows=5566 width=64) (actual time=0.272..1859.740 rows=11438 loops=1)
   Filter: (((status)::text = 'Arrived'::text) AND ((SubPlan 7) > 0))
   Rows Removed by Filter: 21683
   SubPlan 7
     ->  Aggregate  (cost=238.36..238.37 rows=1 width=8) (actual time=0.013..0.013 rows=1 loops=16707)
           ->  Bitmap Heap Scan on boarding_passes boarding_passes_3  (cost=4.92..238.20 rows=64 width=0) (actual time=0.006..0.009 rows=34 loops=16707)
                 Recheck Cond: (flights.flight_id = flight_id)
                 Heap Blocks: exact=15584
                 ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.91 rows=64 width=0) (actual time=0.004..0.004 rows=34 loops=16707)
                       Index Cond: (flights.flight_id = flight_id)
   SubPlan 1
     ->  Aggregate  (cost=15.67..15.68 rows=1 width=8) (actual time=0.029..0.029 rows=1 loops=11438)
           ->  Bitmap Heap Scan on seats  (cost=5.43..15.29 rows=149 width=3) (actual time=0.012..0.018 rows=92 loops=11438)
                 Recheck Cond: (aircraft_code = flights.aircraft_code)
                 Heap Blocks: exact=18263
                 ->  Bitmap Index Scan on seats_pkey  (cost=0.00..5.39 rows=149 width=0) (actual time=0.008..0.008 rows=92 loops=11438)
                       Index Cond: (aircraft_code = flights.aircraft_code)
   SubPlan 2
     ->  Aggregate  (cost=238.36..238.37 rows=1 width=8) (actual time=0.016..0.016 rows=1 loops=11438)
           ->  Bitmap Heap Scan on boarding_passes  (cost=4.92..238.20 rows=64 width=0) (actual time=0.007..0.011 rows=50 loops=11438)
                 Recheck Cond: (flights.flight_id = flight_id)
                 Heap Blocks: exact=15584
                 ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.91 rows=64 width=0) (actual time=0.005..0.005 rows=50 loops=11438)
                       Index Cond: (flights.flight_id = flight_id)
   SubPlan 3
     ->  Aggregate  (cost=15.67..15.68 rows=1 width=8) (actual time=0.031..0.031 rows=1 loops=11438)
           ->  Bitmap Heap Scan on seats seats_1  (cost=5.43..15.29 rows=149 width=3) (actual time=0.012..0.019 rows=92 loops=11438)
                 Recheck Cond: (aircraft_code = flights.aircraft_code)
                 Heap Blocks: exact=18263
                 ->  Bitmap Index Scan on seats_pkey  (cost=0.00..5.39 rows=149 width=0) (actual time=0.008..0.008 rows=92 loops=11438)
                       Index Cond: (aircraft_code = flights.aircraft_code)
   SubPlan 4
     ->  Aggregate  (cost=238.36..238.37 rows=1 width=8) (actual time=0.016..0.016 rows=1 loops=11438)
           ->  Bitmap Heap Scan on boarding_passes boarding_passes_1  (cost=4.92..238.20 rows=64 width=0) (actual time=0.007..0.011 rows=50 loops=11438)
                 Recheck Cond: (flights.flight_id = flight_id)
                 Heap Blocks: exact=15584
                 ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.91 rows=64 width=0) (actual time=0.005..0.005 rows=50 loops=11438)
                       Index Cond: (flights.flight_id = flight_id)
   SubPlan 5
     ->  Aggregate  (cost=238.36..238.37 rows=1 width=8) (actual time=0.015..0.015 rows=1 loops=11438)
           ->  Bitmap Heap Scan on boarding_passes boarding_passes_2  (cost=4.92..238.20 rows=64 width=0) (actual time=0.007..0.011 rows=50 loops=11438)
                 Recheck Cond: (flights.flight_id = flight_id)
                 Heap Blocks: exact=15584
                 ->  Bitmap Index Scan on boarding_passes_flight_id_seat_no_key  (cost=0.00..4.91 rows=64 width=0) (actual time=0.005..0.005 rows=50 loops=11438)
                       Index Cond: (flights.flight_id = flight_id)
   SubPlan 6
     ->  Aggregate  (cost=15.67..15.68 rows=1 width=8) (actual time=0.029..0.030 rows=1 loops=11438)
           ->  Bitmap Heap Scan on seats seats_2  (cost=5.43..15.29 rows=149 width=3) (actual time=0.012..0.018 rows=92 loops=11438)
                 Recheck Cond: (aircraft_code = flights.aircraft_code)
                 Heap Blocks: exact=18263
                 ->  Bitmap Index Scan on seats_pkey  (cost=0.00..5.39 rows=149 width=0) (actual time=0.008..0.008 rows=92 loops=11438)
                       Index Cond: (aircraft_code = flights.aircraft_code)
 Planning time: 0.292 ms
 Execution time: 1860.923 ms
(54 —Å—Ç—Ä–æ–∫–∏)
```

–ü–æ–º–∏–º–æ —Ç–æ–≥–æ, —á—Ç–æ —Å–∞–º –∫–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞–ª –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º –∏ –Ω–µ—á–∏—Ç–∞–µ–º—ã–º,
—Ä–∞–∑–±—Ä–æ—Å –∑–∞—Ç—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —É–≤–µ–ª–∏—á–∏–ª—Å—è —Å 
* `cost=49951.70..58822.59 rows=150273 width=76)`
–¥–æ 
* `cost=0.29..12138437.10 rows=5566 width=64`
, —Ö–æ—Ç—è —Å–∞–º–∏—Ö —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ.

–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å —Å 780.417 ms –¥–æ 1860.923 ms.

–ò –º—ã —Å–Ω–æ–≤–∞ –≤–∏–¥–∏–º, —á—Ç–æ, –∫–∞–∫ –∏ –≤—ã—à–µ, —á–∏—Å–ª–æ —Ü–∏–∫–ª–æ–≤ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å —Å `loops=1`
(–≤ —Å–ª—É—á–∞–µ —Å `JOIN`) –¥–æ `loops=11438` –∏ `loops=16707` —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞–º–∏, 
–ø–æ—Å–∫–æ–ª—å–∫—É —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–µ–ª–∞—Ç—å —Å—Ä–∞–∑—É –¥–≤–∞ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞: —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å 
—á–∏—Å–ª–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç
(–ø–æ —Ç–∞–±–ª–∏—Ü–µ `seats`) –∏ —á–∏—Å–ª–æ –∑–∞–Ω—è—Ç—ã—Ö –º–µ—Å—Ç (–ø–æ —Ç–∞–±–ª–∏—Ü–µ `boarding_passes`).

–ü–æ—ç—Ç–æ–º—É –≤ —Ç–∞–∫–æ–π –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á–∏ –≥–æ—Ä–∞–∑–¥–æ –ª—É—á—à–µ –≤—ã–±—Ä–∞—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

---

